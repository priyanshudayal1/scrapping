<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Script Monitor - Instance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-gray-900 text-white">
    <div class="container mx-auto p-4">
      <!-- Header -->
      <div
        class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg shadow-lg p-6 mb-6"
      >
        <h1 class="text-3xl font-bold mb-2">
          üéØ Multi-Script Scraping Monitor
        </h1>
        <p class="text-lg" id="instanceInfo">Loading instance information...</p>
      </div>

      <!-- Control Panel -->
      <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6 hidden">
        <h2 class="text-xl font-bold mb-4">üéÆ Control Panel</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Start N Scripts -->
          <div>
            <label class="block text-sm font-medium mb-2"
              >Number of Scripts to Start:</label
            >
            <div class="flex gap-2">
              <input
                type="number"
                id="numScripts"
                value="1"
                min="1"
                max="66"
                class="flex-1 bg-gray-700 text-white px-3 py-2 rounded"
              />
              <button
                onclick="startNScripts()"
                class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-medium"
              >
                ‚ñ∂Ô∏è Start
              </button>
            </div>
          </div>

          <!-- Delay Setting -->
          <div>
            <label class="block text-sm font-medium mb-2"
              >Delay Between Starts (seconds):</label
            >
            <input
              type="number"
              id="startDelay"
              value="2"
              min="1"
              max="60"
              class="w-full bg-gray-700 text-white px-3 py-2 rounded"
            />
          </div>

          <!-- Stop All -->
          <div class="flex items-end">
            <button
              onclick="stopAllScripts()"
              class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-medium"
            >
              ‚èπÔ∏è Stop All Scripts
            </button>
          </div>
        </div>
      </div>

      <!-- Overall Statistics -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-gray-800 rounded-lg shadow p-4">
          <p class="text-gray-400 text-sm">Total Scripts</p>
          <p class="text-3xl font-bold text-purple-400" id="totalScripts">0</p>
        </div>
        <div class="bg-gray-800 rounded-lg shadow p-4">
          <p class="text-gray-400 text-sm">Running</p>
          <p class="text-3xl font-bold text-green-400" id="runningScripts">0</p>
        </div>
        <div class="bg-gray-800 rounded-lg shadow p-4">
          <p class="text-gray-400 text-sm">Completed</p>
          <p class="text-3xl font-bold text-blue-400" id="completedScripts">
            0
          </p>
        </div>
        <div class="bg-gray-800 rounded-lg shadow p-4">
          <p class="text-gray-400 text-sm">Total Downloaded</p>
          <p class="text-3xl font-bold text-yellow-400" id="totalDownloaded">
            0
          </p>
        </div>
        <div class="bg-gray-800 rounded-lg shadow p-4">
          <p class="text-gray-400 text-sm">Progress</p>
          <p class="text-3xl font-bold text-pink-400" id="overallProgress">
            0%
          </p>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="bg-gray-800 rounded-lg shadow-lg p-4 mb-6">
        <div class="flex justify-between mb-2">
          <span class="text-sm font-medium">Overall Progress</span>
          <span class="text-sm font-medium" id="progressText">0 / 0 pages</span>
        </div>
        <div class="w-full bg-gray-700 rounded-full h-4">
          <div
            id="progressBar"
            class="bg-gradient-to-r from-purple-500 to-blue-500 h-4 rounded-full transition-all duration-500"
            style="width: 0%"
          ></div>
        </div>
      </div>

      <!-- Filter and Search -->
      <div class="bg-gray-800 rounded-lg shadow-lg p-4 mb-6">
        <div class="flex gap-4 flex-wrap">
          <select
            id="filterStatus"
            onchange="applyFilters()"
            class="bg-gray-700 text-white px-4 py-2 rounded"
          >
            <option value="all">All Scripts</option>
            <option value="running">Running</option>
            <option value="not_started">Not Started</option>
            <option value="completed">Completed</option>
            <option value="error">Error</option>
          </select>
          <input
            type="text"
            id="searchScript"
            onkeyup="applyFilters()"
            placeholder="Search Script ID..."
            class="bg-gray-700 text-white px-4 py-2 rounded flex-1"
          />
          <button
            onclick="refreshStatus()"
            class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-medium"
          >
            üîÑ Refresh
          </button>
        </div>
      </div>

      <!-- Scripts Grid -->
      <div class="bg-gray-800 rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold mb-4">üìä Individual Scripts Status</h2>
        <div
          id="scriptsGrid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
          <!-- Scripts will be dynamically loaded here -->
        </div>
      </div>

      <!-- Status Indicator -->
      <div class="fixed bottom-4 right-4">
        <div
          id="statusIndicator"
          class="bg-gray-800 rounded-full px-4 py-2 shadow-lg"
        >
          <span
            class="inline-block w-3 h-3 rounded-full mr-2"
            id="statusDot"
          ></span>
          <span id="statusText">Loading...</span>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://34.131.163.177/api";
      let allScripts = [];
      let instanceInfo = {};

      async function fetchInstanceInfo() {
        try {
          const response = await fetch(`${API_BASE_URL}/instance/info`);
          const data = await response.json();
          if (data.status === "success") {
            instanceInfo = data;
            document.getElementById("instanceInfo").textContent = `Instance ${
              data.instance_id
            } - Managing ${data.total_scripts} scripts (${
              data.assigned_scripts[0]
            } to ${data.assigned_scripts[data.assigned_scripts.length - 1]})`;
          }
        } catch (error) {
          console.error("Error fetching instance info:", error);
        }
      }

      async function fetchOverallStatus() {
        try {
          const response = await fetch(`${API_BASE_URL}/status`);
          const data = await response.json();

          if (data.status === "success") {
            const status = data.data;
            allScripts = status.scripts;

            // Update overall statistics
            document.getElementById("totalScripts").textContent =
              status.total_scripts;
            document.getElementById("runningScripts").textContent =
              status.running_scripts;
            document.getElementById("completedScripts").textContent =
              status.completed_scripts;
            document.getElementById("totalDownloaded").textContent =
              status.total_files_downloaded.toLocaleString();
            document.getElementById("overallProgress").textContent =
              status.progress_percentage.toFixed(1) + "%";

            // Update progress bar
            document.getElementById("progressBar").style.width =
              status.progress_percentage + "%";
            document.getElementById(
              "progressText"
            ).textContent = `${status.completed_pages.toLocaleString()} / ${status.total_pages.toLocaleString()} pages`;

            // Update scripts grid
            applyFilters();

            // Update status indicator
            updateStatusIndicator(status.running_scripts > 0);
          }
        } catch (error) {
          console.error("Error fetching status:", error);
          updateStatusIndicator(false);
        }
      }

      function applyFilters() {
        const filterStatus = document.getElementById("filterStatus").value;
        const searchText = document
          .getElementById("searchScript")
          .value.toLowerCase();

        let filteredScripts = allScripts;

        // Apply status filter
        if (filterStatus !== "all") {
          filteredScripts = filteredScripts.filter(
            (s) => s.status === filterStatus
          );
        }

        // Apply search filter
        if (searchText) {
          filteredScripts = filteredScripts.filter((s) =>
            s.script_id.toString().includes(searchText)
          );
        }

        renderScripts(filteredScripts);
      }

      function renderScripts(scripts) {
        const grid = document.getElementById("scriptsGrid");

        if (scripts.length === 0) {
          grid.innerHTML =
            '<p class="text-gray-400 col-span-full text-center py-8">No scripts found</p>';
          return;
        }

        grid.innerHTML = scripts
          .map((script) => {
            const statusColor = getStatusColor(script.status);
            const isRunning = script.is_running;
            const progress =
              script.total_pages > 0
                ? (
                    ((script.pages_completed?.length || 0) /
                      script.total_pages) *
                    100
                  ).toFixed(1)
                : 0;

            return `
                    <div class="bg-gray-700 rounded-lg p-4 border-l-4 ${statusColor}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-lg">Script ${
                                  script.script_id
                                }</h3>
                                <p class="text-sm text-gray-400">Pages ${
                                  script.start_page?.toLocaleString() || "N/A"
                                } - ${
              script.end_page?.toLocaleString() || "N/A"
            }</p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-bold ${getStatusBadgeColor(
                              script.status
                            )}">
                                ${isRunning ? "üü¢ Running" : script.status}
                            </span>
                        </div>
                        
                        <div class="space-y-2 mb-3">
                            <div class="flex justify-between text-sm">
                                <span>Downloaded:</span>
                                <span class="font-bold">${(
                                  script.total_files_downloaded || 0
                                ).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Current Page:</span>
                                <span class="font-bold">${(
                                  script.current_page || 0
                                ).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Progress:</span>
                                <span class="font-bold">${progress}%</span>
                            </div>
                        </div>
                        
                        <div class="w-full bg-gray-600 rounded-full h-2 mb-3">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        
                        <div class="flex gap-2">
                            ${
                              !isRunning
                                ? `
                                <button onclick="startScript(${script.script_id})" 
                                        class="flex-1 bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm">
                                    ‚ñ∂Ô∏è Start
                                </button>
                            `
                                : `
                                <button onclick="stopScript(${script.script_id})" 
                                        class="flex-1 bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                                    ‚èπÔ∏è Stop
                                </button>
                            `
                            }
                            <button onclick="viewLogs(${script.script_id})" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                                üìÑ Logs
                            </button>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function getStatusColor(status) {
        switch (status) {
          case "running":
            return "border-green-500";
          case "completed":
            return "border-blue-500";
          case "error":
            return "border-red-500";
          case "not_started":
            return "border-gray-500";
          default:
            return "border-yellow-500";
        }
      }

      function getStatusBadgeColor(status) {
        switch (status) {
          case "running":
            return "bg-green-600";
          case "completed":
            return "bg-blue-600";
          case "error":
            return "bg-red-600";
          case "not_started":
            return "bg-gray-600";
          default:
            return "bg-yellow-600";
        }
      }

      function updateStatusIndicator(isActive) {
        const dot = document.getElementById("statusDot");
        const text = document.getElementById("statusText");

        if (isActive) {
          dot.className =
            "inline-block w-3 h-3 rounded-full mr-2 bg-green-500 animate-pulse";
          text.textContent = "Active";
        } else {
          dot.className = "inline-block w-3 h-3 rounded-full mr-2 bg-gray-500";
          text.textContent = "Idle";
        }
      }

      async function startNScripts() {
        const numScripts = parseInt(
          document.getElementById("numScripts").value
        );
        const delay = parseInt(document.getElementById("startDelay").value);

        if (numScripts < 1) {
          alert("Please enter a valid number of scripts");
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/scripts/start`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ num_scripts: numScripts, delay: delay }),
          });

          const data = await response.json();
          alert(data.message);

          if (data.status === "success") {
            setTimeout(refreshStatus, 1000);
          }
        } catch (error) {
          console.error("Error starting scripts:", error);
          alert("Failed to start scripts");
        }
      }

      async function startScript(scriptId) {
        try {
          const response = await fetch(
            `${API_BASE_URL}/scripts/start/${scriptId}`,
            {
              method: "POST",
            }
          );

          const data = await response.json();
          alert(data.message);

          if (data.status === "success") {
            setTimeout(refreshStatus, 1000);
          }
        } catch (error) {
          console.error("Error starting script:", error);
          alert("Failed to start script");
        }
      }

      async function stopScript(scriptId) {
        if (!confirm(`Stop Script ${scriptId}?`)) return;

        try {
          const response = await fetch(
            `${API_BASE_URL}/scripts/stop/${scriptId}`,
            {
              method: "POST",
            }
          );

          const data = await response.json();
          alert(data.message);
          refreshStatus();
        } catch (error) {
          console.error("Error stopping script:", error);
          alert("Failed to stop script");
        }
      }

      async function stopAllScripts() {
        if (!confirm("Stop all running scripts?")) return;

        try {
          const response = await fetch(`${API_BASE_URL}/scripts/stop-all`, {
            method: "POST",
          });

          const data = await response.json();
          alert(data.message);
          refreshStatus();
        } catch (error) {
          console.error("Error stopping scripts:", error);
          alert("Failed to stop scripts");
        }
      }

      async function viewLogs(scriptId) {
        try {
          const response = await fetch(
            `${API_BASE_URL}/scripts/${scriptId}/logs?lines=50`
          );
          const data = await response.json();

          if (data.status === "success") {
            const logs = data.logs.join("");
            const logWindow = window.open(
              "",
              `Script ${scriptId} Logs`,
              "width=800,height=600"
            );
            logWindow.document.write(`
                        <html>
                        <head><title>Script ${scriptId} Logs</title></head>
                        <body style="background: #1a1a1a; color: #fff; font-family: monospace; padding: 20px;">
                            <h2>Script ${scriptId} - Recent Logs</h2>
                            <pre style="white-space: pre-wrap;">${
                              logs || "No logs available"
                            }</pre>
                        </body>
                        </html>
                    `);
          }
        } catch (error) {
          console.error("Error fetching logs:", error);
          alert("Failed to fetch logs");
        }
      }

      function refreshStatus() {
        fetchOverallStatus();
      }

      // Initialize
      fetchInstanceInfo();
      fetchOverallStatus();

      // Auto-refresh every 5 seconds
      setInterval(refreshStatus, 5000);
    </script>
  </body>
</html>
